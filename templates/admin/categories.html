{% extends "admin/base.html" %}

{% block title %}Kategoriler{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Kategoriler</h1>
    <div>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newCategoryModal">
            <i class="fas fa-plus-circle me-1"></i> Yeni Kategori Ekle
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div>Tüm Kategoriler</div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th style="width: 5%">#</th>
                        <th style="width: 40%">İsim</th>
                        <th style="width: 20%">Slug</th>
                        <th style="width: 15%">Hikaye Sayısı</th>
                        <th style="width: 20%">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    {% if categories %}
                        {% for category in categories %}
                        <tr>
                            <td>{{ category.id }}</td>
                            <td>{{ category.name }}</td>
                            <td>{{ category.slug }}</td>
                            <td>{{ category.posts|length }}</td>
                            <td class="action-buttons">
                                <button type="button" class="btn btn-sm btn-outline-primary edit-category-btn" 
                                        data-id="{{ category.id }}" 
                                        data-name="{{ category.name }}" 
                                        data-slug="{{ category.slug }}"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#editCategoryModal">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <form method="POST" action="{{ url_for('admin_delete_category', id=category.id) }}" class="d-inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Bu kategoriyi silmek istediğinizden emin misiniz? Bu işlem kategoriye ait hikayeleri silmez, ancak onları kategorisiz yapar.');">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center">Henüz kategori bulunmuyor</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- New Category Modal -->
<div class="modal fade" id="newCategoryModal" tabindex="-1" aria-labelledby="newCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin_new_category') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="newCategoryModalLabel">Yeni Kategori</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label required-field">Kategori Adı</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="slug" class="form-label required-field">Slug</label>
                        <div class="input-group">
                            <span class="input-group-text">/category/</span>
                            <input type="text" class="form-control" id="new_slug" name="slug" required>
                        </div>
                        <div class="form-text">URL-dostu bir format kullanın. Boşluklar yerine tire (-) kullanılacaktır.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin_edit_category') }}" id="editCategoryForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="id" id="edit_category_id">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCategoryModalLabel">Kategori Düzenle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_name" class="form-label required-field">Kategori Adı</label>
                        <input type="text" class="form-control" id="edit_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_slug" class="form-label required-field">Slug</label>
                        <div class="input-group">
                            <span class="input-group-text">/category/</span>
                            <input type="text" class="form-control" id="edit_slug" name="slug" required>
                        </div>
                        <div class="form-text">URL-dostu bir format kullanın. Boşluklar yerine tire (-) kullanılacaktır.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">Güncelle</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-generate slug for new category
        const nameInput = document.getElementById('name');
        const slugInput = document.getElementById('new_slug');
        
        if (nameInput && slugInput) {
            nameInput.addEventListener('keyup', function() {
                if (!slugInput.dataset.manuallyChanged) {
                    generateSlug(nameInput, slugInput);
                }
            });
            
            slugInput.addEventListener('input', function() {
                slugInput.dataset.manuallyChanged = 'true';
            });
        }
        
        // Edit category modal population
        const editButtons = document.querySelectorAll('.edit-category-btn');
        
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const name = this.getAttribute('data-name');
                const slug = this.getAttribute('data-slug');
                
                document.getElementById('edit_category_id').value = id;
                document.getElementById('edit_name').value = name;
                document.getElementById('edit_slug').value = slug;
            });
        });
        
        // Auto-generate slug for edit category
        const editNameInput = document.getElementById('edit_name');
        const editSlugInput = document.getElementById('edit_slug');
        
        if (editNameInput && editSlugInput) {
            editNameInput.addEventListener('keyup', function() {
                if (!editSlugInput.dataset.manuallyChanged) {
                    generateSlug(editNameInput, editSlugInput);
                }
            });
            
            editSlugInput.addEventListener('input', function() {
                editSlugInput.dataset.manuallyChanged = 'true';
            });
        }
        
        // Helper function to generate slug
        function generateSlug(nameInput, slugInput) {
            const slug = nameInput.value
                .toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')  // Remove special characters
                .replace(/\s+/g, '-')        // Replace spaces with hyphens
                .replace(/-+/g, '-')         // Replace multiple hyphens with a single one
                .trim();
            
            slugInput.value = slug;
        }
    });
</script>
{% endblock %}
